/**
 * 
 * @see  湖南科创信息技术股份有限公司  lodop6.0技术
 * @since 1.0
 * 
 * @member  
 * 
 * 
 * *****************/
/**
 * 构造对象
 * 
 * */
function KCWebPrint()
{
}

/**
 * IE浏览器打印控件ID
 */
KCWebPrint.prototype.PrintAppID_IE = null;
/**
 * 其它浏览器打印控件ID
 */
KCWebPrint.prototype.PrintAppID_OTHER = null;
/**
 * 当前浏览器中需要使用的打印控件ID
 */
KCWebPrint.prototype.PrintAppID = null;
/**
 * 当前浏览器中打印控件对象
 */
KCWebPrint.prototype.PrintApp = null;

/**
 * 当前WEB应用名称
 */
KCWebPrint.prototype.appCtxPath = null;

/**
 * 异常信息提示
 */
KCWebPrint.prototype.errmsg = alert;

/**
 * 加载浏览器打印控件，并设置当前浏览器中需要使用的ID，本函数必须传入两个参数
 * @param ieEleID IE浏览器控件ID
 * @param otherEleID 其它浏览器打印控件ID
 * @return
 */
KCWebPrint.prototype.loadForLodop = function(ieEleID,otherEleID)
{
	try{
		
		var s = "<object id='"+ieEleID+"' classid='clsid:2105C259-1E0C-4534-8141-A753534CB4CA' width=0 height=0>"; 
		s+="<embed id='"+otherEleID+"' type='application/x-print-lodop' width=0 height=0 pluginspage='install_lodop.exe'></embed>";
		s+="</object>"; 
		//document.write(s);//直接向document中输入
		var div = document.createElement("DIV");
		document.body.appendChild(div);
		div.innerHTML = s;
		
		this.PrintAppID_IE = ieEleID;
		this.PrintAppID_OTHER = otherEleID;
		
		this.getPrintAPP();//获得打印控件对象
		return true;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 获得Lodop打印控件对象
 * @param oOBJECT IE浏览器需要使用的Object元素对象
 * @param oEMBED 其它浏览器需要使用的embed元素对象
 * @return 返回当前浏览器中需要使用的对象
 */
KCWebPrint.prototype.getLodop=function(oOBJECT,oEMBED)
{
/**************************
  本函数根据浏览器类型决定采用哪个对象作为控件实例：
  IE系列、IE内核系列的浏览器采用oOBJECT，
  其它浏览器(Firefox系列、Chrome系列、Opera系列、Safari系列等)采用oEMBED。
**************************/
        var strHtml1="<br><font color='#FF00FF'>打印控件未安装!点击这里<a href='"+this.appCtxPath+"/download_lodop.jsp'>下载安装文件包（解压后执行安装文件install_lodop.exe）</a>,安装后请刷新页面或重新进入。</font>";
        var strHtml2="<br><font color='#FF00FF'>打印控件需要升级!点击这里<a href='"+this.appCtxPath+"/download_lodop.jsp'>下载升级文件包（解压后执行安装文件install_lodop.exe）</a>,升级后请重新进入。</font>";
        var strHtml3="<br><br><font color='#FF00FF'>(注：如曾安装过Lodop旧版附件npActiveXPLugin,请在【工具】->【附加组件】中先卸载它)</font>";
        var LODOP=oEMBED;
	try{		     
	     if (navigator.appVersion.indexOf("MSIE")>=0) LODOP=oOBJECT;
	     
	     if ((LODOP==null)||(typeof(LODOP.VERSION)=="undefined")) {
		 if (navigator.userAgent.indexOf('Firefox')>=0)
  	         document.documentElement.innerHTML=strHtml3+document.documentElement.innerHTML;
		 if (navigator.appVersion.indexOf("MSIE")>=0) document.write(strHtml1); else
		 document.documentElement.innerHTML=strHtml1+document.documentElement.innerHTML;
	     } else if (LODOP.VERSION<"6.0.3.2") {
		 if (navigator.appVersion.indexOf("MSIE")>=0) document.write(strHtml2); else
		 document.documentElement.innerHTML=strHtml2+document.documentElement.innerHTML; 
	     }
	     //*****如下空白位置适合调用统一功能:*********	     
	     LODOP.SET_LICENSES("湖南科创信息技术股份有限公司","956615980837383747594958093190","","");


	     //*******************************************
	     return LODOP; 
	}catch(err){
	     document.documentElement.innerHTML="Error:"+strHtml1+document.documentElement.innerHTML;
	     return LODOP; 
	}
}

/**
 * 获得当前打印控件对象
 * @return
 */
KCWebPrint.prototype.getPrintAPP = function()
{
	try{
		if(!this.PrintAppID)
		{
			this.PrintAppID = this.PrintAppID_OTHER;
			if (navigator.appVersion.indexOf("MSIE")>=0)
			{
				this.PrintAppID = this.PrintAppID_IE;
			}
		}
		if(!this.PrintApp)
		{
			this.PrintApp = this.getLodop(document.getElementById(this.PrintAppID_IE), document.getElementById(this.PrintAppID_OTHER));
		}
		
		return this.PrintApp;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 打印控件初始化
 * @param ieEleID IE浏览器使用的ID
 * @param otherEleID 其它浏览器使用的ID
 * @return
 */
KCWebPrint.prototype.init = function(ieEleID,otherEleID,appCtxPathName)
{
	if(appCtxPathName)
	{
		this.appCtxPath = appCtxPathName;
	}else
	{
		this.appCtxPath = "/zzcz";
	}
	return this.loadForLodop(ieEleID, otherEleID);
}

/**
 * 设置打印参数
 * @param intPrinterIndex 选择打印机序号，对应于系统中打印机序号，可以通过列表获得，值为-999时不设置打印机序号，按系统默认打印机
 * @param intOrient 打印纸张方向
 * 打印方向及纸张类型，数字型，
 * 1---纵(正)向打印，固定纸张；
 * 2---横向打印，固定纸张；
 * 3---纵(正)向打印，宽度固定，高度按打印内容的高度自适应；
 * 0(或其它)----打印方向由操作者自行选择或按打印机缺省设置；
 * @param PageWidth 纸张宽度
 * @param PageHeight 纸张高度，小于等于0时将按纸张名称确定大小
 * @param strPageName 纸张名称，高小大于0时无效
 * @return
 */
KCWebPrint.prototype.setParameter = function(
		intPrinterIndex,//打印机序号
		intOrient,//打印方向 
		PageWidth,//纸张宽度
		PageHeight,//纸张高度
		strPageName,//纸张类型,只有纸张高度小于等于0时才有效
		taskName//打印任务名称
		)
{
	try{
		this.getPrintAPP().PRINT_INIT(taskName?taskName:"");//初始化
		this.getPrintAPP().SET_PRINT_PAGESIZE(intOrient,PageWidth,PageHeight,strPageName);//设置纸张
		if(Number(intPrinterIndex) != -999)
		{
			this.getPrintAPP().SET_PRINTER_INDEXA(Number(intPrinterIndex));
		}
		return true;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 将当前系统中所有打印机填充到下接框中
 * @param selectElement 下拉框元素对象
 * @return
 */
KCWebPrint.prototype.getPrinterList = function(selectElement,defaultPrinter)
{
	try{
		if(!selectElement)return false;
		selectElement.length = 0;
		var option=new Option();//document.createElement('option');
		option.innerHTML="系统默认打印机";
		option.value=-1;
		selectElement.appendChild(option);
		var iPrinterCount=this.getPrintAPP().GET_PRINTER_COUNT();
		for(var i=0;i<iPrinterCount;i++){
			option=new Option();//document.createElement('option');
			option.innerHTML=this.getPrintAPP().GET_PRINTER_NAME(i);
			option.value=i;
			selectElement.appendChild(option);
			
			if(defaultPrinter)
			{
				if(this.getPrintAPP().GET_PRINTER_NAME(i).indexOf(defaultPrinter) != -1)
				{
					selectElement.options[i].selected = true;
				}
			}
			
		};
		
		return true;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
};

/**
 * 将当前打印机所支持纸张类型填充到下拉框中
 * @param printerIndex 当前打印机序号
 * @param selectElement 下拉框元素对象
 * @return
 */
KCWebPrint.prototype.getPrinterPaperList = function (printerIndex,selectElement,defaultPaper)
{
	try{
		if(!selectElement)return false;
		selectElement.length = 0;
		var strPageSizeList=this.getPrintAPP().GET_PAGESIZES_LIST(printerIndex,"\n");
		var Options=strPageSizeList.split("\n");       
		for (i=0;i<Options.length;i++ )
		{
			var option=new Option();//document.createElement('option');   
			option.innerHTML=Options[i];
			option.value=Options[i];
			selectElement.appendChild(option);
			
			if(defaultPaper)
			{
				if(option.innerHTML.indexOf(defaultPaper) != -1)
				{
					//selectElement.options[i].selected = true;//IE6报错
				}
			}
		}
		return true;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}
 
/**
 * 将打印纸张方向填充到下拉框中
 * @param selectElement 下拉框元素对象
 * @return
 */
KCWebPrint.prototype.setOrient = function(selectElement)
{
	try{
		if(!selectElement)return false;
		var orient = [{n:'纵向固定长度',v:1},{n:'横向固定长度',v:2},{n:'纵向自适应长度',v:3},{n:'打印机默认',v:0}];
		var option = null;
		selectElement.length = 0;
		for(var i = 0; i < orient.length; i++)
		{
			option = new Option();
			option.innerHTML = orient[i].n;
			option.value = orient[i].v;
			selectElement.appendChild(option);
		}
		return true;
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 增加一个URL打印内容
 * @param Top 上边距
 * @param Left 左边距
 * @param Width 内容宽度
 * @param Height 内容高度
 * @param strURL 打印内容URL
 * @return
 */
KCWebPrint.prototype.addContentURL = function(Top,Left,Width,Height,strURL)
{
	try{
		return this.getPrintAPP().ADD_PRINT_URL(Top, Left, Width, Height,strURL);
	}catch (e) {
		this.errmsg(e.message);
	}
}
/**
 * 增加一个超文本打印内容
 * @author haibing.xia0@chinacreator.com
 * @param Top 上边距
 * @param Left 左边距
 * @param Width 内容宽度
 * @param Height 内容高度
 * @param strHtmlContent 打印内容strHtmlContent
 * @return
 */
KCWebPrint.prototype.addContentHTML= function(Top,Left,Width,Height,strHtmlContent)
{
	try{
		return this.getPrintAPP().ADD_PRINT_HTM(Top, Left, Width, Height,strHtmlContent);
	}catch (e) {
		this.errmsg(e.message);
	}
}
/**
 * 执行打印预览
 * @return
 */
KCWebPrint.prototype.preview = function()
{
	try{
		return (this.getPrintAPP().PREVIEW());
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 打开打印窗口选择打印机执行打印任务
 * @return
 */
KCWebPrint.prototype.selectPrint = function()
{
	try{
		return (this.getPrintAPP().PRINTA());
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 直接打印
 * @return
 */
KCWebPrint.prototype.print = function()
{
	try{
		return (this.getPrintAPP().PRINT());
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}
/**
 * @author haibing.xia0@chinacreator.com
 * 选择打印机
 * @return
 */
/*KCWebPrint.prototype.printC = function()
{
	try{
		return (this.getPrintAPP().PRINTA());
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}*/
/**
 * 打印设置
 * @return
 */
KCWebPrint.prototype.setup = function()
{
	try{
		return (this.getPrintAPP().PRINT_SETUP());
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 将表格内容输出到文件中
 * @param filename 文件名
 * @param prompt 是否弹出文件目录选择框,在为false时传入文件名为绝对路径
 * @param quick 是否采用快速导出方式
 * @return
 */
KCWebPrint.prototype.printToFile = function(filename,prompt,quick)
{
	try{
		
		if(!filename)
		{
			this.errmsg("请输入正确的文件名!");
			return false;
		}
		
		if(quick)
		{
			this.getPrintAPP().SET_SAVE_MODE("QUICK_SAVE",true);
		}
		
		if(!prompt){
			this.getPrintAPP().SET_SAVE_MODE("FILE_PROMPT",false);
		}
		
		return this.getPrintAPP().SAVE_TO_FILE(filename);
	}catch(e){
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 设置双面打印
 * @return
 */
KCWebPrint.prototype.doubleSided = function()
{
	try{
		return this.getPrintAPP().SET_PRINT_MODE("DOUBLE_SIDED_PRINT",true);
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 取消双面打印
 * @return
 */
KCWebPrint.prototype.singleSided = function()
{
	try{
		return this.getPrintAPP().SET_PRINT_MODE("DOUBLE_SIDED_PRINT",false);
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 设置打印起始页
 * @param startpage
 * @return
 */
KCWebPrint.prototype.startPage = function(startpage)
{
	try{
		if(Number(startpage))
		{
			return this.getPrintAPP().SET_PRINT_MODE("PRINT_START_PAGE", Number(startpage));
		}
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}

/**
 * 设置打印结束页，不设置时打印到最后一页
 * @param endpage
 * @return
 */
KCWebPrint.prototype.endPage = function(endpage)
{
	try{
		if(Number(endpage))
		{
			return this.getPrintAPP().SET_PRINT_MODE("PRINT_END_PAGE", Number(endpage));
		}
	}catch (e) {
		this.errmsg(e.message);
	}
	return false;
}
/**
 * 注入打印控件参数
 * @author haibing.xiao@chinacreator.com
 * @param initTask 打印控件元素ID ,webapp 当前WEB应用名称,width 纸张的宽度,height 纸张高度
 * */
 KCWebPrint.prototype.setPrintParams= function(initTask,webapp,width,height){
	    //this.getPrintAPP().PRINT_INIT(initTask);
	    //alert(webapp);
	    if(!width || width==''){
	    	width="1200mm";
	    }
	    if(height || height==''){
	    	height="1000mm";
	    }
	    this.init("print1","print2",webapp);//初始化打印控件 第一个参数表示IE浏览器元素ID，第二个参数表示其它浏览器参数名称 ,第三个contextPath
	    this.getPrinterList(document.getElementById("PrinterList"));//获得打印机列表
	    this.getPrinterPaperList(document.getElementById("PrinterList").value,document.getElementById("PaperList"));//获表当前打印机支持纸张列表
	    this.setOrient(document.getElementById("Orient"));
	    this.setParameter(document.getElementById('PrinterList').value,document.getElementById("Orient").value,width,height,document.getElementById('PaperList').value,initTask);//设置打印任务
    	
} 
/*KCWebPrint.prototype.setPrintParams= function(initTask,intOrient,PageWidth,PageHeight,strPageName){
	var _initTask,_Orient,_PageWidth,_PageHeight,_strPageName;
	if(!initTask){
		_initTask="taskp";
	}else{
		_initTask=initTask;
	}
	if(!Orient){
		_Orient="2";
	}else{
		_Orient=Orient;
	}
	if(!PageWidth){
		_PageWidth="2";
	}else{
		_PageWidth=PageWidth;
	}
	if(!PageHeight){
		_PageHeight="2";
	}else{
		_PageHeight=PageHeight;
	}
	if(!strPageName){
		_strPageName="2";
	}else{
		_strPageName=strPageName;
	}
	this.getPrintAPP().PRINT_INIT(_initTask);//初始化
	this.getPrintAPP().SET_PRINT_PAGESIZE(_Orient,_PageWidth,_PageHeight,_strPageName);//设置纸张
	
	 
}*/
 
/***
 * 过滤打印的数据
 * @param  param1 打印的容器id,param2 数组 不需要打印的IDS,ptype 打印的类型(1 单据打印，2 列表打印) 
 * 2012-07-09进行扩展  
 * */
KCWebPrint.prototype.getPrintHTML= function(param1,param2,ptype,pids){
	
	 var strHTML="";
	 var _style='<style> table td,th {border-width: 1px; border-style: solid;border-color: #0000FF;}   </style>';
	 if(ptype && ptype===1){
		 var _phtml=$("#"+param1);
		 if(param2){
			 for(var i=0;i<param2.length;){
				 var p=param2[i];
				 $("#"+p).hide();
				 //alert(i);
				 i=i+1;
			 } 
		 }
		 strHTML=_phtml.html();	 
	 }else if(ptype && ptype===2){
		 var _phtml=$("#"+param1);
		 if(pids){
			 _phtml.find("tr td input[type=checkbox]").each(function(i){
				 var result= $(this).val();
				 if(pids.indexOf(result)>=0){
					 //$(this).parent().parent().hide();
				 }else{
					 $(this).parent().parent().hide();
				 }
			 });
			 for(var i=0;i<param2.length;){
				 var p=param2[i];
				 $("#"+p).hide();
				 i=i+1;
			 } 
		   strHTML=_style+_phtml.html();	 
		 }
	 }
	 
	 return  strHTML;
}
/***
 * 恢复过滤打印的数据
 * @param param1 数组 需要恢复打印的IDS ,ptype 打印的类型(1 单据打印，2 列表打印),pids为选择数据的主键 
 * */
KCWebPrint.prototype.recoveryPrintHTML= function(param1,ptype,pids){
	if(!param1){
		return ;
	}
 
	if( ptype && ptype===1){
		for(var i=0;i<param1.length;){
			 var p=param1[i];
			 $("#"+p).show();
			 i=i+1;
			 //alert(i);
		 }
	}else if(ptype && ptype===2){
		
		if(pids){
			var _phtml=$("#"+param1);
			 _phtml.find("tr td input[type=checkbox]").each(function(i){
				 var result= $(this).val();
				 if(pids.indexOf(result)>=0){
					$(this).attr("checked","true");
					//alert(i);
				 } 
			 });
			 
		 }
	}
	 
	 
}
/**
 * 
 * @author haibing.xiao@chinacreator.com
 * @version 1.0
 * @param top ,left ,width , height , printid ,ids ,task 
 * 
 * */
KCWebPrint.prototype.setPrintInit=function(top,left,width,height,printid,ids,task){
	//如果不传递任何参数 ,启用默认参数
	if(!top){
		var top ="100";
	}
	if(!left){
		var left="1000";
		}
	if(!width){
		var width="2100";
	}
	if(!height){
		var height="2000";
	}
	if(!printid){
		printid="docform";
	}
	if(!ids){
		ids="";
	}
	if(!task){
		task="task1";
	}
	var strHTML=this.getPrintHTML("docform",ids);
	this.setParameter(document.getElementById('PrinterList').value,document.getElementById("Orient").value,_width,_height,document.getElementById('PaperList').value,task);//设置
	this.addContentHTML(top,left,width,height,strHTML);
}
/**
 * @author haibing.xiao
 * @param  pid 单据主键,names 需要填充的单据字段
 * @see  根据pid  自动生成动态打印文本域
 * **/
KCWebPrint.prototype.getPrintJSON=function(webapp,docketid,mytype,keyname,pid,names){
	 if(!pid){
		 return ;
	 }
	 var json={};
	 var dat="{\"_myDocketId\":\""+docketid+"\",\"_myType\":\""+mytype+"\",\""+keyname+"\":\""+pid+"\"}";
	 //alert(dat);
	 $.ajax({
			   type: "POST",
			   url: webapp+"/common/control/executeAJAX.page",
			   data: {jsonStr:dat},
			   cache:false,
			   async:false,
			   dataType:'json',
			   success: function(resp){
				   //alert(JSON.stringify(resp));
			     for(var i=0;i<names.length;){
			    	 var name=names[i];
			    	 json[name]=resp[name];
			    	 i=i+1;
			    	 //alert(json[name]);
			     }
			   },
			   error:function(err){
				  alert("自动生成打印单据出错!");
			   }
	});
	return json;
}
/**
 * @author haibing.xiao
 * @param  json
 * @see  根据json对象  自动生成动态打印文本域
 * **/
KCWebPrint.prototype.createPrintText=function(json){
	var _top =53;
	var _left=187;
	var _width=120;
	var _height=20;
	var  obj = this.getPrintAPP();
	obj.SET_PRINT_STYLE("FontSize",11);//
	//var data =$.parseJSON(json);
	var data=json;
	for (var attr in data){
		var _value=attr+":"+data[attr];
		obj.ADD_PRINT_TEXT(_top,_left,_width,_height,_value);
		_top=_top+30;
	}
}
/**
 * @author haibing.xiao
 * @see   打印设计函数
 * */
KCWebPrint.prototype.print_design=function(){
	
	this.getPrintAPP().PRINT_DESIGN();	
}
/**
 * @author haibing.xiao
 * @param url  
 * @see   加载背景图片
 * */
KCWebPrint.prototype.setup_bkimg=function(url){
	var s_url="<img border='0' src='"+url+"'>";
	//this.getPrintAPP().ADD_PRINT_SETUP_BKIMG("<img border='0' src='http://s1.sinaimg.cn/middle/721e77e5t99431b026bd0&690'>");
	this.getPrintAPP().ADD_PRINT_SETUP_BKIMG(s_url);
}

